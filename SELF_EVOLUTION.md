# 系统自进化机制详解

## 核心问题

**如果根据爆文，agent发现了新的爆文要素或者规则，系统会如何处理？会自动完善相关配置吗？**

**答案：是的！系统会自动学习、更新和优化规则库。**

---

## 完整的自进化流程

### 阶段 1: 发现新规则

**触发方式**：
- 用户提供爆文进行分析
- 系统批量分析热门内容
- 定期监控平台趋势

**Analyzer 的工作**：
1. 深度分析爆文（标题、结构、节奏、互动）
2. 分析评论区（用户痛点、需求、情感共鸣）
3. 提炼新的规则模式

**示例**：
```
分析爆文: "🔥7天瘦10斤！这个方法太绝了"
发现规则: emoji + 数字 + 时间 + 结果 + 惊叹
```

---

### 阶段 2: 智能规则管理

#### 2.1 规则去重和合并

**问题**: 避免规则库中出现重复或相似的规则

**解决方案**:

**判断标准**：
- 规则模式（pattern）相似度 > 80%
- 规则类别（category）相同
- 标签（tags）重叠度 > 50%

**处理方式**：

**情况 1: 完全新规则**
```json
{
  "id": "xhs_title_005",
  "category": "title",
  "pattern": "emoji+数字+时间+结果",
  "examples": ["🔥7天瘦10斤"],
  "score": 0.7,
  "source_count": 1,
  "last_updated": "2026-01-12"
}
```
→ 直接添加到规则库

**情况 2: 相似规则存在**
```
现有规则: "数字+动词+结果" (source_count: 15, score: 0.90)
新发现: "数字+时间+结果" (相似度: 85%)
```
→ 不添加新规则，而是更新现有规则：
- 合并 examples: ["7天瘦10斤", "3招搞定面试", ...]
- source_count: 15 → 16
- score: 0.90 → 0.92（重新计算）
- last_updated: 更新时间戳

**情况 3: 规则冲突**
```
现有规则: "标题不要超过15字"
新发现: "标题可以20字，更详细"
```
→ 保留两条规则，标注"存在争议"，降低权重

---

#### 2.2 动态权重调整

**公式**：
```
score = (source_count / (source_count + 5)) * 0.7 + time_factor * 0.3
```

**示例计算**：

**新规则**（刚发现）:
- source_count = 1
- time_factor = 1.0（最近7天）
- score = (1/6) * 0.7 + 1.0 * 0.3 = 0.117 + 0.3 = **0.42**

**成熟规则**（多次验证）:
- source_count = 15
- time_factor = 1.0（最近7天）
- score = (15/20) * 0.7 + 1.0 * 0.3 = 0.525 + 0.3 = **0.83**

**老规则**（90天未更新）:
- source_count = 15
- time_factor = 0.4（90天以上）
- score = (15/20) * 0.7 + 0.4 * 0.3 = 0.525 + 0.12 = **0.65**

**权重意义**：
- 0.9-1.0: 极高权重，Writer **必须**应用
- 0.7-0.9: 高权重，Writer **优先**应用
- 0.5-0.7: 中等权重，Writer **建议**应用
- 0.3-0.5: 低权重，Writer **可选**应用
- 0.0-0.3: 极低权重，考虑归档

---

#### 2.3 规则淘汰机制

**问题**: 过时或无效的规则会污染规则库

**解决方案**: 自动归档低效规则

**归档条件**（同时满足）：
- score < 0.3
- 超过30天未更新
- source_count < 3

**处理方式**：
```
移动到: knowledge/rules/{platform}/archived_rules.json
记录原因: "权重过低 (0.25)，30天未更新"
保留历史: 不删除，便于后续分析
```

**示例**：
```json
// 归档的规则
{
  "id": "xhs_opening_003",
  "pattern": "使用大量emoji开头",
  "score": 0.25,
  "source_count": 2,
  "last_updated": "2025-12-01",
  "archived_date": "2026-01-12",
  "archived_reason": "权重过低，30天未更新"
}
```

---

### 阶段 3: 自动应用到创作

**关键**: 更新后的规则库会在下次 Writer 创作时**自动读取和应用**

**Writer 的工作流程**：

1. **读取最新规则库**
   ```
   Read: knowledge/rules/xiaohongshu/base_rules.json
   ```

2. **按权重排序**
   ```
   高权重规则优先: score >= 0.7
   ```

3. **应用到内容生成**
   ```
   标题: 应用 xhs_title_001 (score: 0.92)
   开头: 应用 xhs_opening_001 (score: 0.90)
   结构: 应用 xhs_structure_002 (score: 0.85)
   ```

4. **标注应用的规则**
   ```markdown
   ## 应用的规则
   - xhs_title_001: 数字+动词+结果 (权重: 0.92)
   - xhs_opening_001: 痛点共鸣+解决方案预告 (权重: 0.90)
   ```

5. **Reviewer 验证**
   - 检查规则是否正确应用
   - 评估应用效果
   - 反馈到规则权重调整

---

### 阶段 4: 持续学习循环

```
分析爆文 → 发现新规则 → 更新规则库 → 应用到创作 → 评分反馈 → 调整权重 → 再次应用
```

**示例循环**：

**第1次**:
- 发现规则: "emoji+数字+结果" (score: 0.7)
- 应用到创作: 生成标题 "🔥5个方法效率翻倍"
- Reviewer 评分: 8.5/10
- 反馈: 规则有效

**第2次**:
- 再次发现相同规则
- 更新: source_count 1→2, score 0.7→0.75
- 应用到创作: 生成标题 "⚡️7天养成高效习惯"
- Reviewer 评分: 8.8/10
- 反馈: 规则持续有效

**第3次**:
- 再次发现相同规则
- 更新: source_count 2→3, score 0.75→0.78
- 权重提升，优先级提高

**第N次**:
- source_count 达到 15
- score 达到 0.92（高权重）
- 成为"必须应用"的核心规则

---

## 自动完善的配置

### 1. 规则库自动更新

**文件**: `knowledge/rules/{platform}/base_rules.json`

**更新内容**：
- 新增规则
- 更新 source_count
- 重新计算 score
- 更新 last_updated
- 合并 examples

**更新频率**: 每次分析爆文后立即更新

---

### 2. findings.md 自动记录

**文件**: `findings.md`

**记录内容**：
```markdown
## 2026-01-12 分析发现

### 分析的爆文
- 标题: 🔥7天瘦10斤！这个方法太绝了
- 平台: xiaohongshu
- 数据: 5.2万赞，8.3万收藏

### 新增规则
1. xhs_title_005: emoji+数字+时间+结果 (初始权重: 0.7)

### 更新规则
1. xhs_title_001: source_count 15→16, score 0.90→0.92

### 归档规则
1. xhs_opening_003: 权重过低 (0.25)，30天未更新

### 关键发现
- 用户对"新手友好"的需求增加
- "科学依据"成为新的信任要素
- "时间管理"成为高频潜在选题
```

---

### 3. progress.md 自动追踪

**文件**: `progress.md`

**记录内容**：
```markdown
## 2026-01-12 23:45

### 任务: 分析爆文并更新规则库
- 分析爆文数: 1
- 新增规则: 1
- 更新规则: 2
- 归档规则: 1
- 规则库版本: 1.0 → 1.1

### 任务: 基于新规则创作内容
- 选题: 职场人的高效减肥法
- 应用规则: 5条（包括新规则）
- 评分: 8.6/10
- 状态: 已发布
```

---

## 实际使用示例

### 示例 1: 单次分析和应用

```bash
/ralph-loop "分析小红书爆文并应用新规则创作内容。

**爆文**:
标题: 🔥7天瘦10斤！这个方法太绝了
[完整内容]

**任务**:
1. 调用 Analyzer 分析爆文
2. 发现新规则并更新规则库（自动去重、合并、计算权重）
3. 基于更新后的规则库创作新内容
4. Reviewer 评分
5. 如果评分 < 8.0，优化
6. 更新 findings.md 和 progress.md
7. 输出 <promise>COMPLETE</promise>

平台: xiaohongshu
新选题: 职场人的高效减肥法" \
--max-iterations 30 --completion-promise "COMPLETE"
```

**系统会自动**：
- ✅ 分析爆文，提炼规则
- ✅ 检查规则是否重复（去重）
- ✅ 合并相似规则（更新 source_count 和 score）
- ✅ 归档低效规则
- ✅ 保存更新后的规则库
- ✅ Writer 读取最新规则库
- ✅ 应用高权重规则到新内容
- ✅ 记录到 findings.md 和 progress.md

**完全自动化，无需手动干预！**

---

### 示例 2: 批量学习和进化

```bash
/ralph-loop "批量分析小红书爆文，持续优化规则库。

**爆文列表**: 10篇高赞内容

**任务**:
1. 对每篇爆文：
   a. Analyzer 分析并提炼规则
   b. 智能更新规则库（去重、合并、权重调整）
2. 汇总分析结果：
   - 高频规则（出现在多篇爆文中）
   - 新趋势规则
   - 需要归档的规则
3. 基于优化后的规则库创作3篇新内容
4. 每篇内容都经过评分和优化
5. 生成'规则库进化报告'
6. 输出 <promise>COMPLETE</promise>

平台: xiaohongshu" \
--max-iterations 50 --completion-promise "COMPLETE"
```

**系统会自动**：
- ✅ 分析10篇爆文
- ✅ 提炼和合并规则（避免重复）
- ✅ 识别高频规则（多次出现 → 高权重）
- ✅ 发现新趋势（新规则）
- ✅ 淘汰过时规则（低权重 → 归档）
- ✅ 生成进化报告
- ✅ 应用优化后的规则库创作新内容

---

## 自进化的优势

### 1. 持续学习

**传统方式**: 规则固定，需要人工更新
**自进化系统**: 自动从爆文中学习，持续优化

### 2. 权重动态调整

**传统方式**: 所有规则权重相同
**自进化系统**: 高频规则权重高，过时规则自动降权

### 3. 规则去重和合并

**传统方式**: 规则库越来越臃肿
**自进化系统**: 自动合并相似规则，保持精简

### 4. 自动淘汰

**传统方式**: 过时规则一直存在
**自进化系统**: 低效规则自动归档

### 5. 即时应用

**传统方式**: 发现新规则 → 手动更新 → 手动应用
**自进化系统**: 发现新规则 → 自动更新 → 自动应用

---

## 总结

### 问题：系统会自动完善相关配置吗？

**答案：是的！**

**自动完善的内容**：
1. ✅ **规则库**（knowledge/rules/{platform}/base_rules.json）
   - 新增规则
   - 更新权重
   - 合并相似规则
   - 归档低效规则

2. ✅ **发现记录**（findings.md）
   - 记录每次分析的发现
   - 追踪规则演化历史

3. ✅ **进度追踪**（progress.md）
   - 记录每次迭代的结果
   - 追踪系统学习进度

4. ✅ **归档文件**（archived_rules.json）
   - 保存过时规则
   - 便于后续分析

**不需要手动干预的操作**：
- ❌ 不需要手动添加规则
- ❌ 不需要手动调整权重
- ❌ 不需要手动删除重复规则
- ❌ 不需要手动归档过时规则
- ❌ 不需要手动应用新规则

**系统会自动完成所有这些操作！**

---

**这就是真正的"自进化"系统：从爆文中学习 → 自动优化规则库 → 应用到新内容 → 持续改进**
